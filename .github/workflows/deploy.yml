name: SMU-CLUB CD

on:
  push:
    branches: [ "prod" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          platforms: linux/arm64
          push: true
          tags: ${{ secrets.DOCKER_HUB_USERNAME }}/smu-club-backend:latest
  deploy-to-oci:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Deploy to OCI Instance
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.OCI_HOST }}
          username: ${{ secrets.OCI_USERNAME }}
          key: ${{ secrets.OCI_SSH_KEY }}
          script: |
            cd /home/opc/smu-club
            
            git fetch origin
            git reset --hard origin/prod
            # .env 파일 생성 (환경변수 주입)
            cat <<EOF > .env
            SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }}
            SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}
            SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            OCI_CONFIG_TENANCY_ID=${{ secrets.OCI_CONFIG_TENANCY_ID }}
            OCI_CONFIG_USER_ID=${{ secrets.OCI_CONFIG_USER_ID }}
            OCI_CONFIG_FINGERPRINT=${{ secrets.OCI_CONFIG_FINGERPRINT }}
            OCI_CONFIG_REGION=${{ secrets.OCI_CONFIG_REGION }}
            OCI_BUCKET_NAME=${{ secrets.OCI_BUCKET_NAME }}
            OCI_BUCKET_NAMESPACE=${{ secrets.OCI_BUCKET_NAMESPACE }}
            SPRING_MAIL_HOST=${{ secrets.SPRING_MAIL_HOST }}
            SPRING_MAIL_PORT=${{ secrets.SPRING_MAIL_PORT }}
            OCI_SMTP_USERNAME=${{ secrets.OCI_SMTP_USERNAME }}
            OCI_SMTP_PASSWORD=${{ secrets.OCI_SMTP_PASSWORD }}
            SMUNITY_AUTH_API_URL=${{ secrets.SMUNITY_AUTH_API_URL }}
            DISCORD_WEBHOOK_URL=${{ secrets.DISCORD_WEBHOOK_URL }}
            CIRCUIT_BREAKER_THRESHOLD=${{ secrets.CIRCUIT_BREAKER_THRESHOLD }}
            LOGGING_LEVEL_HIBERNATE_SQL=${{ secrets.LOGGING_LEVEL_HIBERNATE_SQL }}
            DDL_AUTO_MODE=${{ secrets.DDL_AUTO_MODE }}
            EOF
            
            # OCI API Key (.pem) 파일 생성
            # 호스트 서버에 파일을 먼저 생성하고, docker-compose에서 볼륨으로 마운트
            echo "${{ secrets.OCI_API_KEY }}" > oci_api_key.pem
            chmod 600 oci_api_key.pem
            
            # SSL / TLS 인증서 파일 생성
            echo "${{ secrets.SSL_CERT }}" > cert.pem
            echo "${{ secrets.SSL_KEY }}" > key.pem
            chmod 600 cert.pem
            chmod 600 key.pem
            
            # Docker Compose 실행
            docker-compose --profile prod down || true
            # 새 이미지로 컨테이너 실행 (빌드 과정 없이 바로 실행)
            docker-compose --profile prod up -d
            
            docker image prune -f
            
            rm -rf .env
