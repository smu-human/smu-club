name: SMU-CLUB CD

on:
  push:
    branches: [ "master" ] # 메인 브랜치에 푸시될 때 실행

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. 서버에 접속하기 위한 SSH 설정 및 배포 작업
      - name: Deploy to OCI Instance
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.OCI_HOST }} # 서버 IP 주소
          username: ${{ secrets.OCI_USERNAME }} # 보통 'opc' 또는 'ubuntu'
          key: ${{ secrets.OCI_SSH_KEY }} # 서버 접속용 SSH Private Key
          script: |
            # 이동할 디렉토리 설정 (본인의 프로젝트 경로로 수정)
            cd /home/opc/smu-club 
            
            # 소스 코드 업데이트 (Git이 설치된 경우)
            git fetch origin
            git reset --hard origin/master
            
            # 2. .env 파일 생성 (환경변수 주입)
            cat <<EOF > .env
            SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }}
            SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}
            SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            OCI_CONFIG_TENANCY_ID=${{ secrets.OCI_CONFIG_TENANCY_ID }}
            OCI_CONFIG_USER_ID=${{ secrets.OCI_CONFIG_USER_ID }}
            OCI_CONFIG_FINGERPRINT=${{ secrets.OCI_CONFIG_FINGERPRINT }}
            OCI_CONFIG_REGION=${{ secrets.OCI_CONFIG_REGION }}
            OCI_BUCKET_NAME=${{ secrets.OCI_BUCKET_NAME }}
            OCI_BUCKET_NAMESPACE=${{ secrets.OCI_BUCKET_NAMESPACE }}
            OCI_SMTP_USERNAME=${{ secrets.OCI_SMTP_USERNAME }}
            OCI_SMTP_PASSWORD=${{ secrets.OCI_SMTP_PASSWORD }}
            DISCORD_WEBHOOK_URL=${{ secrets.DISCORD_WEBHOOK_URL }}
            DDL_AUTO_MODE=${{ secrets.DDL_AUTO_MODE }}
            EOF
            
            # 3. OCI API Key (.pem) 파일 복원
            # 시크릿에 저장된 텍스트를 파일로 만듭니다.
            echo "${{ secrets.OCI_PRIVATE_KEY }}" > oci_api_key.pem
            chmod 600 oci_api_key.pem

            docker-compose --profile prod down || true
            docker builder prune -af
            docker-compose --profile prod build --no-cache
            docker-compose --profile prod up -d
            
            docker image prune -f